#include "object.h"

#include "util.h"

#include <stdlib.h>


/** 802C80F8(J) */
void applyPlatformDisplacement(v3f *p, v3h *marioFaceAngle, Object *plat) {
  Mtxf displMatrix;

  v3h rotation;
  rotation.pitch = (s16) plat->platformRotation.pitch;
  rotation.yaw   = (s16) plat->platformRotation.yaw;
  rotation.roll  = (s16) plat->platformRotation.roll;

  // if (mario) {
  //   v8032FEC0 = 0;
  //   getMarioPos(&x, &y, &z);
  // }
  // else {
  //   x = curObj->pos.x;
  //   y = curObj->pos.y;
  //   z = curObj->pos.z;
  // }
  f32 x, y, z;
  x = p->x;
  y = p->y;
  z = p->z;

  x += plat->vel.x;
  z += plat->vel.z;

  if (rotation.pitch != 0 || rotation.yaw != 0 || rotation.roll != 0) {
    // s16 val4A = rotation.pitch;
    // s16 val48 = rotation.roll;
    // s16 val46 = plat->displayAngle.yaw;

    if (marioFaceAngle != NULL)
      marioFaceAngle->yaw += rotation.yaw;

    v3f currObjOffset;
    currObjOffset.x = x - plat->pos.x;
    currObjOffset.y = y - plat->pos.y;
    currObjOffset.z = z - plat->pos.z;
    
    rotation.pitch = plat->displayAngle.pitch - plat->platformRotation.pitch;
    rotation.yaw   = plat->displayAngle.yaw   - plat->platformRotation.yaw;
    rotation.roll  = plat->displayAngle.roll  - plat->platformRotation.roll;
    
    v3f currObjRotation;
    matrixFromTransAndRot(&displMatrix, &currObjOffset, &rotation);
    matrixTransposeVecMult(&displMatrix, &currObjRotation, &currObjOffset);
    
    rotation.pitch = plat->displayAngle.pitch;
    rotation.yaw   = plat->displayAngle.yaw;
    rotation.roll  = plat->displayAngle.roll;
    
    v3f objOffset;
    matrixFromTransAndRot(&displMatrix, &currObjOffset, &rotation);
    matrixVecMult(&displMatrix, &objOffset, &currObjRotation);
    
    x = plat->pos.x + objOffset.x;
    y = plat->pos.y + objOffset.y;
    z = plat->pos.z + objOffset.z;
  }

  // if (mario) {
  //   setMarioPos(x, y, z);
  // }
  // else {
  //   curObj->pos.x = x;
  //   curObj->pos.y = y;
  //   curObj->pos.z = z;
  // }
  p->x = x;
  p->y = y;
  p->z = z;
}


static s16 jrbShipModel[];


void initJrbShipAfloat(Object *o) {
  *o = (Object) {};
  o->pos = (v3f) { 4880, 820, 2375 };
  o->scale = (v3f) { 1, 1, 1 };
  o->collisionModel = &jrbShipModel;
}


void updateJrbShipAfloat(Object *curObj) {
  s16 startPitch = (s16) curObj->displayAngle.pitch;
  s16 startRoll = (s16) curObj->displayAngle.roll;
  // p802A3470();
  
  curObj->v0F4 += 0x100;

  curObj->displayAngle.pitch = (s32) (1024.0f * sins(curObj->v0F4));
  curObj->displayAngle.roll = (s32) (1024.0f * sins(curObj->v0F8));
  
  curObj->platformRotation.pitch = curObj->displayAngle.pitch - startPitch;
  curObj->platformRotation.roll = curObj->displayAngle.roll - startRoll;
}


void updateJrbShipAfloatIndex(Object *curObj, s32 idx) {
  s16 startPitch = (s16) curObj->displayAngle.pitch;
  s16 startRoll = (s16) curObj->displayAngle.roll;
  // p802A3470();
  
  curObj->v0F4 = idx * 0x100;

  curObj->displayAngle.pitch = (s32) (1024.0f * sins(curObj->v0F4));
  curObj->displayAngle.roll = (s32) (1024.0f * sins(curObj->v0F8));
  
  curObj->platformRotation.pitch = curObj->displayAngle.pitch - startPitch;
  curObj->platformRotation.roll = curObj->displayAngle.roll - startRoll;
}


static s16 jrbShipModel[] = {
  0x0040,0x004f,0xfd9b,0x02cd,0xffd0,0xfd34,0x0466,0xffa5,
  0xfd34,0x02cd,0xffd0,0x02cd,0x0466,0xffa5,0xfd9b,0x0466,
  0xffa5,0xfd34,0x04cd,0xff9b,0xfd9b,0x04cd,0xff9b,0xfd9b,
  0x0466,0xface,0x0266,0x0466,0xffa5,0x0266,0x0466,0xfae2,
  0xfd9b,0x0466,0xfae2,0xfd34,0x0533,0xface,0xfd9b,0x0533,
  0xface,0x02cd,0x04cd,0xff9b,0x0266,0x0466,0xface,0x02cd,
  0x0533,0xface,0x0266,0x02cd,0xffd0,0xfece,0x0333,0x0a00,
  0xfd9b,0x02cd,0x079a,0xfd34,0x02cd,0x079a,0xfd9b,0x0266,
  0xffdb,0x0266,0x0266,0x079a,0x0266,0x02cd,0x079a,0x02cd,
  0x02cd,0xffd0,0x019a,0x0333,0x0a00,0x019a,0x0600,0xf934,
  0x0200,0x0600,0xf934,0x0133,0x0600,0xf8ce,0xfece,0x0600,
  0xf8ce,0x0133,0x0600,0xf867,0xffd8,0x0400,0x0d9a,0x0066,
  0x0400,0x0b9a,0x0029,0x0466,0x0d9a,0xff9b,0x02cd,0x0c00,
  0xff9b,0xff9b,0x0a66,0x0066,0x02cd,0x0c00,0x0066,0x039a,
  0x0b33,0x0133,0x0333,0x0a00,0x02cd,0x0000,0x079a,0x0000,
  0xfe01,0x0800,0x0000,0xfece,0xf99b,0x02cd,0x0000,0xfc67,
  0x019a,0x0133,0x0a00,0x0266,0x04cd,0xface,0xfe67,0x04cd,
  0xf953,0xfece,0x0600,0xf867,0xfe01,0x0600,0xf934,0xfe67,
  0x0600,0xf934,0xff9a,0xfece,0xf99b,0x0133,0x02cd,0xf867,
  0xfece,0x02cd,0xf867,0xff9b,0x039a,0x0b33,0xff9b,0x0400,
  0x0b9a,0xffd8,0x0466,0x0d9a,0xff9b,0x039a,0x0b9a,0x0266,
  0x0266,0xffdb,0x0066,0x0333,0x0b33,0xfece,0x0266,0x0a00,
  0xfe67,0x0333,0x0a00,0xfe67,0x0133,0x0a00,0xfd34,0x0000,
  0xfc67,0x0000,0xfe01,0xfc67,0xfe01,0x02cd,0xf934,0x0266,
  0x04cd,0xff9b,0x0266,0x0533,0xface,0xfd9b,0x0266,0x079a,
  0x0133,0x0266,0x0a00,0x02cd,0x02cd,0x079a,0x0133,0x04cd,
  0xf8ed,0x019a,0x04cd,0xf953,0xfece,0x04cd,0xf8ec,0x0029,
  0x0400,0x0d9a,0x0066,0xff9b,0x0a66,0xff9b,0x0333,0x0b33,
  0x0200,0x02cd,0xf934,0xfd86,0x0466,0xfae2,0x027b,0x0466,
  0xfae2,0xfd9b,0x04cd,0xface,0xfd34,0x0000,0x079a,0x0000,
  0x008c,0x0002,0x0005,0x000b,0x0000,0x0001,0x0002,0x0000,
  0x0003,0x0001,0x0001,0x0004,0x0005,0x0004,0x0006,0x0005,
  0x0006,0x0004,0x0007,0x0004,0x0008,0x0009,0x0004,0x0009,
  0x000a,0x000b,0x0005,0x0006,0x000b,0x0006,0x000c,0x0006,
  0x0007,0x000c,0x0008,0x000d,0x003f,0x0008,0x0003,0x000d,
  0x000e,0x0008,0x003f,0x000d,0x000f,0x0040,0x000d,0x0040,
  0x003f,0x000f,0x000d,0x0017,0x000e,0x003f,0x0040,0x0000,
  0x0010,0x0003,0x0010,0x0017,0x0003,0x0011,0x0012,0x0013,
  0x0011,0x0041,0x0012,0x0012,0x0000,0x0002,0x0013,0x0012,
  0x0002,0x0012,0x0041,0x0014,0x0012,0x0014,0x0000,0x0000,
  0x0014,0x0010,0x0014,0x0037,0x0010,0x0011,0x0039,0x0041,
  0x0011,0x0013,0x003a,0x0015,0x0010,0x0037,0x0015,0x0016,
  0x0010,0x0016,0x0015,0x0042,0x0017,0x0010,0x0043,0x0010,
  0x0016,0x0043,0x000f,0x001a,0x0019,0x0016,0x0042,0x0025,
  0x0018,0x0016,0x0025,0x0018,0x0043,0x0016,0x000f,0x0019,
  0x0040,0x0019,0x002b,0x0040,0x001a,0x001b,0x0019,0x001b,
  0x0044,0x0045,0x001a,0x001d,0x001b,0x001b,0x0045,0x0019,
  0x001c,0x0044,0x001b,0x001d,0x001c,0x001b,0x0019,0x0045,
  0x002b,0x001c,0x0046,0x0044,0x001d,0x002d,0x001c,0x001e,
  0x0020,0x0035,0x001e,0x0047,0x0020,0x001f,0x0020,0x0023,
  0x0020,0x0047,0x0023,0x0021,0x0023,0x0047,0x0021,0x0047,
  0x001e,0x0022,0x0048,0x0023,0x0022,0x0023,0x0021,0x0023,
  0x0048,0x002a,0x0021,0x001e,0x0035,0x0026,0x0029,0x0017,
  0x0018,0x0024,0x001f,0x0018,0x0025,0x0024,0x0024,0x0034,
  0x001f,0x0024,0x0033,0x0034,0x0025,0x0038,0x0024,0x0024,
  0x0049,0x0033,0x0024,0x0038,0x0049,0x001f,0x0023,0x0018,
  0x0025,0x0042,0x0038,0x000f,0x0017,0x0029,0x002a,0x0026,
  0x0018,0x0026,0x0027,0x003d,0x0027,0x0026,0x0048,0x0026,
  0x002a,0x0048,0x0026,0x003d,0x0029,0x0026,0x0017,0x0043,
  0x0028,0x004a,0x0029,0x000f,0x0029,0x004a,0x0029,0x003d,
  0x0028,0x0023,0x002a,0x0018,0x0026,0x0043,0x0018,0x002b,
  0x004b,0x004c,0x002b,0x004d,0x004b,0x002c,0x004d,0x002b,
  0x002c,0x002b,0x0045,0x002c,0x0045,0x0044,0x002c,0x0044,
  0x0046,0x0031,0x0032,0x001d,0x002d,0x002e,0x002f,0x002e,
  0x000c,0x002f,0x002e,0x000b,0x000c,0x000c,0x002c,0x002f,
  0x000c,0x004d,0x002c,0x002d,0x002f,0x001c,0x002f,0x0046,
  0x001c,0x002f,0x002c,0x0046,0x0028,0x0030,0x0031,0x0030,
  0x0032,0x0031,0x0032,0x002d,0x001d,0x0033,0x0049,0x0039,
  0x0033,0x003a,0x0034,0x0033,0x0011,0x003a,0x0033,0x0039,
  0x0011,0x0034,0x0036,0x0035,0x0035,0x001f,0x0034,0x0035,
  0x0020,0x001f,0x0037,0x0041,0x0015,0x0021,0x0035,0x0036,
  0x0027,0x0048,0x0022,0x0036,0x0034,0x003a,0x0037,0x0014,
  0x0041,0x0038,0x0039,0x0049,0x0039,0x0042,0x0015,0x0039,
  0x0015,0x0041,0x0038,0x0042,0x0039,0x0031,0x004a,0x0028,
  0x0030,0x0028,0x003d,0x003a,0x0021,0x0034,0x003a,0x003b,
  0x0021,0x003a,0x0013,0x004e,0x0022,0x003b,0x004e,0x003b,
  0x0022,0x0021,0x0022,0x004e,0x0027,0x003c,0x003d,0x004e,
  0x003d,0x0027,0x004e,0x0013,0x0002,0x004e,0x0002,0x003c,
  0x004e,0x003a,0x004e,0x003b,0x003c,0x0002,0x000b,0x003c,
  0x003e,0x0030,0x003e,0x003c,0x000b,0x0030,0x003d,0x003c,
  0x0030,0x003e,0x0032,0x002d,0x0032,0x002e,0x0032,0x003e,
  0x002e,0x002e,0x003e,0x000b,0x000f,0x004a,0x001a,0x001a,
  0x004a,0x0031,0x001a,0x0031,0x001d,0x0041
};
